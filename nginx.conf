# nginx.conf (性能与安全优化版)

# --- 压缩配置 (放在 server 块之外) ---
# Brotli (推荐)
brotli on;
brotli_comp_level 6;
brotli_types text/plain text/css application/javascript application/json image/svg+xml application/xml+rss;
# Gzip (后备)
gzip on;
gzip_vary on;
gzip_proxied any;
gzip_comp_level 6;
gzip_types text/plain text/css application/javascript application/json image/svg+xml;


server {
    listen 443 ssl http2;
    listen [::]:443 ssl http2;
    server_name mcp.so.kg;

    # --- SSL 安全与性能优化 ---
    ssl_certificate /etc/nginx/certs/live/mcp.so.kg/fullchain.pem;
    ssl_certificate_key /etc/nginx/certs/live/mcp.so.kg/privkey.pem;
    ssl_protocols TLSv1.2 TLSv1.3;
    ssl_prefer_server_ciphers off;
    
    # OCSP Stapling
    ssl_stapling on;
    ssl_stapling_verify on;
    ssl_trusted_certificate /etc/nginx/certs/live/mcp.so.kg/fullchain.pem;
    
    # HSTS
    add_header Strict-Transport-Security "max-age=63072000; includeSubDomains" always;
    
    # --- 基础配置 ---
    root /usr/share/nginx/html;
    index index.html;
    charset utf-8;
    
    # --- 错误页面 ---
    error_page 404 /404.html;
    location = /404.html { internal; }
    
    # --- 静态资源缓存配置 (放在 location / 前面) ---
    location ~* \.(css|js|jpg|jpeg|png|gif|ico|svg|webp|woff|woff2|ttf|eot)$ {
        expires 30d;
        add_header Cache-Control "public, no-transform";
    }
    
    # --- SPA 主路由逻辑 ---
    location / {
        try_files $uri $uri/ /index.html;
    }
}

# --- HTTP 重定向 (保持不变) ---
server {
    listen 80;
    listen [::]:80;
    server_name mcp.so.kg;
    return 301 https://$server_name$request_uri;
}